<!DOCTYPE html>
<title>PinSafari</title>

<script type="text/javascript">

PinSafari = new Object; // I'm not sure, do we need to namespace work?

PinSafari.itemURL = '';
PinSafari.itemTitle = '';
PinSafari.itemDescription = '';

/*
 * seems like eventually it'd be nice to have a toggle between using the inline or popup
 */
PinSafari.openPinboardWindow = function(event) {

  /* as a heads up, the itemDescription is already URI encoded when 
   * passed back from the message event listener
   */
  
  code = ''
	code += '<style type="text/css">';
	code += '#ws-popup { position: fixed; right: 10px; top: 10px; background-color: rgba( 0,0,0, 0.9); border: 1px solid black; -webkit-border-radius: 5px; -webkit-box-shadow: 1px 1px 1px #000; width: 300px; color: white !important; font-family: "Arial", sans-serif; font-size: 12px; z-index: 999999; line-height: 1.5em;  }';
	code += '#ws-popup #ws-text { width: 100%; margin: 20px 10px; }';
	code += '#ws-popup h2 { font-size: 14px; margin: 5px 0 10px 0; color: white !important; line-height: 1.5em; padding: 0 0 0 20px; background: url('+safari.extension.baseURI+'logo_bigger.png) no-repeat; }';
	code += '#ws-popup p { color: white !important; line-height: 1.5em; padding: 0; margin: 0; }';
	code += '#ws-popup .button { display: inline-block; outline: none; cursor: pointer; text-align: center; text-decoration: none; padding: .25em 1em .25em; margin: 10px 5px 0; text-shadow: 0 1px 1px rgba(0,0,0,.3); -webkit-border-radius: .5em; -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.2); color: #fef4e9; }';
	code += '#ws-popup .button.submit { background: #0c0; border: 1px solid #0c3; }';
	code += '#ws-popup .button.close { background: #c00; border: 1px solid #f00; }';
	code += '</style>';
	code += '<div id="ws-popup">';
	code += '<div id="ws-text">';
  code += '<h2>Add to Pinboard</h2>';
  code += '<div id="ws-form">';
  code += '<form id="ws-form-form">';
  code += '<label for="pb_title">Title</label><br />';
  code += '<input id="pb_title" type="text" name="title" size="50" value="'+PinSafari.itemTitle+'" /><br />';
  code += '<label for="pb_url">URL</label><br />';
  code += '<input id="pb_url" type="text" name="url" size="50" value="'+PinSafari.itemURL+'" /><br />';
  code += '<label for="pb_desc">Description</label><br />';
  code += '<textarea id="pb_desc" name="description" rows="3" cols="36">'+PinSafari.itemDescription+'</textarea><br />';
  code += '<a href="javascript:void(0);" id="ws-submit-button" class="button submit">Save</a>';
  code += '<a href="javascript:void(0);" id="ws-close-button" class="button close">Cancel</a>';
  code += '</form>';
  code += '</div>';
	code += '</div>';
	code += '</div>';

  event.target.disabled = true;
  
	event.target.browserWindow.activeTab.page.dispatchMessage('open', code);
	
};

PinSafari.performCommand = function(event)
{
  if (event.command === 'pinsafari')
  {
    // Get the current tab's URL
    var itemUrl = event.target.browserWindow.activeTab.url; 

    // There's nothing to do if there's no URL
	if (itemUrl)
	{        
      /*
       * dispatch a message to the current page where an injected script is listening
       */
      event.target.browserWindow.activeTab.page.dispatchMessage("addtopinboard_get_selection","");
      
    }
  }
  else
  {  
    // unknown command
    return;
  }  
}

PinSafari.validateCommand = function(event)
{
  if (event.command === 'pinsafari') {
    event.target.disabled = !event.target.browserWindow.activeTab.url;
  }
  else
  {
    // unknown command
    return;  
  }
}

PinSafari.respondToMessage = function(messageEvent)
{
  if(messageEvent.name === "addtopinboard_get_selection")
  {
    /*
     * receives a message from the current page where the injected text selection script is listening
     */
    
    // do we need massage messageEvent.message? does pinboard.in have a description max char?
     
    PinSafari.itemURL = safari.application.activeBrowserWindow.activeTab.url;
    PinSafari.itemTitle = safari.application.activeBrowserWindow.activeTab.title;     
    PinSafari.itemDescription = String(messageEvent.message);
    PinSafari.openPinboardWindow(messageEvent);
    return;
  }
  else
  {
    //unknown messageEvent
    return 
  }
}

PinSafari.storeUserAndPass = function(event) {
  if (event.key === 'pinboardUser') {
    localStorage.setItem('pinboardUser', event.newValue);
  }
  if (event.key === 'pinboardPass') {
    localStorage.setItem('pinboardPass', event.newValue);
  }
}

safari.application.addEventListener("message",PinSafari.respondToMessage,false);
safari.application.addEventListener('command',PinSafari.performCommand, false);
safari.application.addEventListener('validate',PinSafari.validateCommand, false);
safari.application.addEventListener('change',PinSafari.storeUserAndPass,false);

</script>